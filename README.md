# TechCosmos AIOS (AI Utility System)一个基于效用理论（Utility Theory）的 AI 行为决策系统，用于 Unity 游戏开发。## 功能特性- ✅ **效用决策**：基于权重计算的智能行为选择- ✅ **状态管理**：灵活的状态机和行为切换- ✅ **动态权重**：实时计算行为效用值- ✅ **模块化设计**：高度可扩展的组件架构- ✅ **自动执行**：内置 Update 循环自动决策## 核心架构```AI (MonoBehaviour)├── BehavioralExecutSystem (行为执行系统)└── UtilityEvaluationSystem (效用评估系统)    └── BaseState (状态基类)```## 快速开始### 基本用法```csharpusing TechCosmos.AIOS.Runtime;using TechCosmos.AIOS.Runtime.System;using TechCosmos.AIOS.Runtime.Structs;using UnityEngine;public class EnemyAI : AI{    protected override void OnInitialized()    {        // 注册行为        EvaluationSystem.RegisterUtilityCommand("Attack", new WeightBehavior(            weight: () => CalculateAttackWeight(),            action: () => Attack()        ));                EvaluationSystem.RegisterUtilityCommand("Patrol", new WeightBehavior(            weight: () => CalculatePatrolWeight(),             action: () => Patrol()        ));                // 创建并切换状态        var combatState = new CombatState(new[] { "Attack", "Patrol" }, EvaluationSystem);        BehavioralExecutSystem.HandOffState(combatState);    }        private float CalculateAttackWeight()    {        // 根据距离、血量等因素计算攻击权重        return 0.8f;    }        private float CalculatePatrolWeight()    {        // 计算巡逻权重        return 0.3f;    }        private void Attack() => Debug.Log("执行攻击");    private void Patrol() => Debug.Log("执行巡逻");}public class CombatState : BaseState{    public CombatState(string[] behaviorNames, UtilityEvaluationSystem evaluationSystem)         : base(behaviorNames, evaluationSystem) { }}```### 高级用法```csharp// 批量注册行为EvaluationSystem.RegisterUtilityCommand(    ("Attack", new WeightBehavior(() => 0.8f, Attack)),    ("Defend", new WeightBehavior(() => 0.6f, Defend)),    ("Heal", new WeightBehavior(() => 0.9f, Heal)));// 手动触发特定行为选择currentState.UpdateChoice("Attack", "Defend");// 注销行为EvaluationSystem.UnRegisterUtilityCommand("Attack");EvaluationSystem.UnRegisterUtilityCommand("Attack", "Defend", "Heal");```## API 文档### 核心类：`AI`主控制器类，继承自 `MonoBehaviour`。**属性：**- `BehavioralExecutSystem` - 行为执行系统- `EvaluationSystem` - 效用评估系统  - `IsInitialized` - 初始化状态- `IsExecuting` - 是否正在执行- `CurrentStateName` - 当前状态名称**方法：**- `Initialize()` - 手动初始化系统- `OnInitialized()` - 可重写的初始化回调### 类：`BehavioralExecutSystem`行为执行状态机。**方法：**- `Update()` - 每帧更新决策- `Choice()` - 触发行为选择- `HandOffState(IState state)` - 切换状态### 类：`UtilityEvaluationSystem`效用评估和决策系统。**方法：**```csharp// 注册单个行为void RegisterUtilityCommand(string name, WeightBehavior behavior)// 批量注册行为  void RegisterUtilityCommand(params (string, WeightBehavior)[] values)// 注销行为void UnRegisterUtilityCommand(string name)void UnRegisterUtilityCommand(params string[] names)// 决策执行void ChoiceBehavor(params string[] behaviorNames)void ChoiceBehavor()void FinalDecisionMaking(params WeightBehavior[] utilityWeights)```### 抽象类：`BaseState`状态基类，实现 `IState` 接口。**构造函数：**```csharpBaseState(string[] behaviorNames, UtilityEvaluationSystem evaluationSystem)```**方法：**- `UpdateChoice(params string[] behaviors)` - 更新行为选择### 结构体：`WeightBehavior`权重行为结构体。**字段：**- `Func<float> weightCalculator` - 权重计算函数- `Action action` - 执行动作**构造函数：**```csharpWeightBehavior(Func<float> weight, Action action)```### 接口：`IState`状态接口。**属性：**- `_evaluationSystem` - 效用评估系统- `behaviorNames` - 行为名称数组**方法：**- `UpdateChoice(params string[] behaviors)` - 更新选择## 使用示例### 1. NPC 行为决策```csharppublic class NPCState : BaseState{    public NPCState(UtilityEvaluationSystem system)         : base(new[] { "Talk", "Trade", "Idle" }, system) { }}// 注册 NPC 行为EvaluationSystem.RegisterUtilityCommand(    ("Talk", new WeightBehavior(() => PlayerNearby() ? 0.9f : 0.1f, Talk)),    ("Trade", new WeightBehavior(() => PlayerHasMoney() ? 0.8f : 0.2f, Trade)),    ("Idle", new WeightBehavior(() => 0.3f, Idle)));```### 2. 战斗 AI```csharppublic class BattleState : BaseState{    private Enemy enemy;        public BattleState(UtilityEvaluationSystem system, Enemy enemy)         : base(new[] { "Melee", "Range", "Heal", "Flee" }, system)    {        this.enemy = enemy;    }        private float MeleeWeight() => enemy.DistanceToPlayer < 3f ? 0.9f : 0.1f;    private float FleeWeight() => enemy.Health < 0.3f ? 0.95f : 0.1f;}```### 3. 动态行为更新```csharppublic class DynamicState : BaseState{    public DynamicState(UtilityEvaluationSystem system) : base(new string[0], system) { }        public void UpdateBehaviors(string[] newBehaviors)    {        // 动态更新可用行为        behaviorNames = newBehaviors;    }}```## 最佳实践1. **权重设计**：确保权重函数返回 0-1 范围内的值2. **性能优化**：复杂的权重计算考虑缓存或优化3. **状态管理**：合理划分状态和行为粒度4. **错误处理**：为权重函数添加异常处理5. **调试支持**：添加决策日志便于调试## 注意事项- ⚠️ 权重计算函数不应有副作用- ⚠️ 行为名称区分大小写- ⚠️ 空行为或无效权重会被自动过滤- ⚠️ 确保在初始化后使用系统## 版本信息- **Unity 版本**：2019.4+- **.NET 版本**：4.x- **命名空间**：`TechCosmos.AIOS.Runtime`## 许可证MIT License